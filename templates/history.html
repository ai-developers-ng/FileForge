{% extends 'base.html' %}

{% block title %}Job History | FileForge{% endblock %}
{% block meta_description %}View your recent file conversion and OCR processing jobs.{% endblock %}

{% block content %}
<div class="static-page">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
        <div>
            <h1>Job History</h1>
            <p class="page-subtitle">Recent processing jobs (last 50)</p>
        </div>
        {% if jobs %}
        <button id="clearHistoryBtn" class="ghost btn" style="color:#dc2626;border-color:#dc2626;">Clear All History</button>
        {% endif %}
    </div>

    {% if jobs %}
    <div class="history-table-wrap">
        <table class="docs-table history-table" id="historyTable">
            <thead>
                <tr>
                    <th>File</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Progress</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for job in jobs %}
                <tr data-job-id="{{ job.id }}" data-job-status="{{ job.status }}">
                    <td class="history-filename">{{ job.filename }}</td>
                    <td>
                        <span class="format-badge">{{ job.options.get('job_type', 'ocr') | upper }}</span>
                    </td>
                    <td>
                        <span class="history-status history-status--{{ job.status }}">{{ job.status }}</span>
                    </td>
                    <td>
                        <div class="history-progress-wrap">
                            <div class="history-progress-track">
                                <div class="history-progress-fill history-progress-fill--{{ job.status }}" style="width: {{ job.progress }}%"></div>
                            </div>
                            <span class="history-progress-text">{{ job.progress }}%</span>
                        </div>
                    </td>
                    <td class="history-date">{{ job.created_at[:19].replace('T', ' ') }}</td>
                    <td>
                        {% if job.status == 'completed' %}
                            <a href="/results/{{ job.id }}?token={{ job.token }}" class="history-action">View</a>
                        {% else %}
                            &mdash;
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>No jobs found. Upload a file to get started.</p>
    {% endif %}
</div>

<script>
(function () {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || "";
    const table = document.getElementById("historyTable");
    if (!table) return;

    const refreshActiveJobs = async () => {
        const activeRows = table.querySelectorAll('tr[data-job-status="queued"], tr[data-job-status="running"]');
        if (activeRows.length === 0) return;

        for (const row of activeRows) {
            const jobId = row.dataset.jobId;
            try {
                const res = await fetch(`/api/jobs/${jobId}`);
                if (!res.ok) continue;
                const job = await res.json();

                const progress = typeof job.progress === "number" ? Math.min(100, Math.max(0, job.progress)) : 0;

                // Update status badge
                const statusEl = row.querySelector(".history-status");
                if (statusEl) {
                    statusEl.className = `history-status history-status--${job.status}`;
                    statusEl.textContent = job.status;
                }

                // Update progress bar
                const fill = row.querySelector(".history-progress-fill");
                if (fill) {
                    fill.style.width = `${progress}%`;
                    fill.className = `history-progress-fill history-progress-fill--${job.status}`;
                }
                const text = row.querySelector(".history-progress-text");
                if (text) text.textContent = `${progress}%`;

                // Update row status for next poll cycle
                row.dataset.jobStatus = job.status;

                // Update actions column
                const actionsCell = row.querySelector("td:last-child");
                if (actionsCell) {
                    if (job.status === "completed") {
                        actionsCell.innerHTML = `<a href="/results/${jobId}" class="history-action">View</a>`;
                    } else if (job.status === "failed") {
                        actionsCell.innerHTML = "&mdash;";
                    }
                }
            } catch {
                // Skip failed fetches
            }
        }

        // Continue polling if there are still active jobs
        const remaining = table.querySelectorAll('tr[data-job-status="queued"], tr[data-job-status="running"]');
        if (remaining.length > 0) {
            setTimeout(refreshActiveJobs, 2000);
        }
    };

    // Start polling if any active jobs exist
    const hasActive = table.querySelectorAll('tr[data-job-status="queued"], tr[data-job-status="running"]').length > 0;
    if (hasActive) {
        setTimeout(refreshActiveJobs, 2000);
    }
})();

// Clear All History
(function () {
    const btn = document.getElementById("clearHistoryBtn");
    if (!btn) return;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || "";

    btn.addEventListener("click", async () => {
        const confirmed = confirm(
            "Clear all history?\n\nThis will permanently delete all uploaded files and processed results in your session. This cannot be undone."
        );
        if (!confirmed) return;

        btn.disabled = true;
        btn.textContent = "Clearingâ€¦";

        try {
            const res = await fetch("/api/history", {
                method: "DELETE",
                headers: { "X-CSRFToken": csrfToken },
            });
            if (res.ok) {
                window.location.reload();
            } else {
                const data = await res.json().catch(() => ({}));
                alert("Failed to clear history: " + (data.error || res.statusText));
                btn.disabled = false;
                btn.textContent = "Clear All History";
            }
        } catch (err) {
            alert("Network error: " + err.message);
            btn.disabled = false;
            btn.textContent = "Clear All History";
        }
    });
})();
</script>
{% endblock %}
